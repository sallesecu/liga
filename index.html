<!DOCTYPE html>
<html lang="es" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ligas La Salle Tuxtla</title>
    <!-- Cargar las librer√≠as de React y Babel para JSX -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Cargar la librer√≠a de Tailwind CSS desde un CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        .nav-button {
            @apply flex items-center py-2 px-4 rounded-full text-gray-800 font-medium hover:bg-black hover:bg-opacity-10 transition-all duration-300;
        }
        .btn-primary {
             @apply py-2 px-5 bg-[#101097] text-white font-semibold rounded-lg shadow-md hover:bg-[#001E61] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#101097] transition-all duration-300;
        }
        .btn-danger {
            @apply py-2 px-5 bg-[#CE0E2D] text-white font-semibold rounded-lg shadow-md hover:bg-[#a80b24] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#CE0E2D] transition-all duration-300;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 transition-colors duration-300">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;

        // --- Icon Components ---
        const PlusIcon = ({ className = 'w-5 h-5' }) => (
            <svg className={className} fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fillRule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clipRule="evenodd" /></svg>
        );
        const CalendarIcon = ({ className = 'w-5 h-5' }) => (
            <svg className={className} fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fillRule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clipRule="evenodd" /></svg>
        );
        const TrophyIcon = ({ className = 'w-5 h-5' }) => (
            <svg className={className} fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M11 6V5a1 1 0 011-1h2a1 1 0 110 2h-1v5a1 1 0 01-1 1h-2a1 1 0 01-1-1V7a1 1 0 011-1zM5 8V7a1 1 0 011-1h2a1 1 0 110 2H6v3a1 1 0 01-1 1H4a1 1 0 01-1-1V8a1 1 0 011-1h1zM10 2a8 8 0 100 16 8 8 0 000-16zM6 10a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1z" /></svg>
        );
        const EditIcon = ({ className = 'w-5 h-5' }) => (
            <svg className={className} fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fillRule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clipRule="evenodd" /></svg>
        );
        const TrashIcon = ({ className = 'w-5 h-5' }) => (
            <svg className={className} fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fillRule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clipRule="evenodd" /></svg>
        );
        const ChevronDownIcon = ({ className = 'w-5 h-5' }) => (
            <svg className={className} fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fillRule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clipRule="evenodd" /></svg>
        );
        const ChevronUpIcon = ({ className = 'w-5 h-5' }) => (
            <svg className={className} fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fillRule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z" clipRule="evenodd" /></svg>
        );
        const LockIcon = ({ className = 'w-5 h-5' }) => (
            <svg className={className} fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fillRule="evenodd" d="M5 9V7a5 5 0 0110 0v2h2a2 2 0 012 2v6a2 2 0 01-2 2H3a2 2 0 01-2-2v-6a2 2 0 012-2h2zm8-2v2H7V7a3 3 0 016 0z" clipRule="evenodd" /></svg>
        );

        const SportIcon = ({ sport }) => {
            const icons = { 'F√∫tbol': '‚öΩÔ∏è', 'B√°squetbol': 'üèÄ', 'Tocho': 'üèà', 'Voleibol': 'üèê' };
            return <span className="mr-2 text-2xl">{icons[sport] || ''}</span>;
        };

        const Modal = ({ show, message, onClose }) => {
            if (!show) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60 backdrop-blur-sm">
                    <div className="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-2xl max-w-sm w-full text-center border-t-4 border-[#101097]">
                        <p className="text-gray-800 dark:text-white text-lg mb-6">{message}</p>
                        <button onClick={onClose} className="btn-primary w-full">Aceptar</button>
                    </div>
                </div>
            );
        };

        const TeamDetailsModal = ({ team, players, matches, onClose, getTeamName, getTeamLogo }) => {
            if (!team) return null;

            const teamPlayers = players.filter(p => p.teamId === team.id);
            const upcomingMatches = matches
                .filter(m => (m.homeTeamId === team.id || m.awayTeamId === team.id) && new Date(m.date) >= new Date())
                .sort((a, b) => new Date(a.date) - new Date(b.date));

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60 backdrop-blur-sm p-4" onClick={onClose}>
                    <div className="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-2xl max-w-3xl w-full text-left border-t-4 border-[#101097]" onClick={e => e.stopPropagation()}>
                        <div className="flex flex-col sm:flex-row items-start sm:items-center mb-4">
                            <img src={team.logoUrl} alt={`Logo de ${team.name}`} className="w-16 h-16 rounded-full mr-4 mb-4 sm:mb-0 shadow-md" />
                            <h3 className="text-3xl font-bold">{team.name}</h3>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <h4 className="text-xl font-semibold mb-3 border-b pb-2">Jugadores</h4>
                                {teamPlayers.length > 0 ? (
                                    <ul className="space-y-2">
                                        {teamPlayers.map(player => <li key={player.id} className="bg-gray-50 dark:bg-gray-700/50 p-2 rounded-md">{player.name}</li>)}
                                    </ul>
                                ) : (
                                    <p className="text-sm text-gray-400 italic">No hay jugadores registrados.</p>
                                )}
                            </div>
                            <div>
                                <h4 className="text-xl font-semibold mb-3 border-b pb-2">Pr√≥ximos Partidos</h4>
                                {upcomingMatches.length > 0 ? (
                                    <div className="space-y-3">
                                        {upcomingMatches.map(match => (
                                            <div key={match.id} className="bg-gray-50 dark:bg-gray-700/50 p-3 rounded-lg">
                                                <p className="text-sm font-medium text-gray-600 dark:text-gray-300">{new Date(match.date).toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
                                                <div className="flex items-center justify-between mt-2 text-base">
                                                    <div className="flex items-center font-bold">
                                                        <img src={getTeamLogo(match.homeTeamId)} className="w-6 h-6 rounded-full mr-2" />
                                                        {getTeamName(match.homeTeamId)}
                                                    </div>
                                                    <span className="font-extrabold text-[#101097] dark:text-blue-300 mx-2">vs</span>
                                                    <div className="flex items-center font-bold">
                                                        {getTeamName(match.awayTeamId)}
                                                        <img src={getTeamLogo(match.awayTeamId)} className="w-6 h-6 rounded-full ml-2" />
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                ) : (
                                    <p className="text-sm text-gray-400 italic">No hay partidos pr√≥ximos.</p>
                                )}
                            </div>
                        </div>

                        <div className="text-right mt-8">
                            <button onClick={onClose} className="btn-primary">Cerrar</button>
                        </div>
                    </div>
                </div>
            );
        };

        const StandingsTable = ({ standings, onTeamClick }) => {
            if (standings.length === 0) {
                return <p className="text-center text-gray-500 dark:text-gray-400 py-4">No hay datos de clasificaci√≥n para esta liga.</p>;
            }
            return (
                <div className="overflow-x-auto rounded-xl shadow-lg bg-white dark:bg-gray-800">
                    <table className="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                        <thead className="bg-gray-50 dark:bg-gray-700/50">
                            <tr>
                                <th className="px-6 py-3 text-left text-xs font-bold text-gray-600 dark:text-gray-200 uppercase tracking-wider">Equipo</th>
                                {
                                    ['PJ', 'G', 'E', 'P', 'GF', 'GC', 'DG', 'Pts'].map(header => (
                                        <th key={header} className="px-4 py-3 text-center text-xs font-bold text-gray-600 dark:text-gray-200 uppercase tracking-wider">{header}</th>
                                    ))
                                }
                            </tr>
                        </thead>
                        <tbody className="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                            {standings.map((team, index) => (
                                <tr key={index} className="hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors duration-200">
                                    <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">
                                        <div className="flex items-center cursor-pointer" onClick={() => onTeamClick(team.id)}>
                                            <img src={team.logoUrl} alt={`Logo de ${team.teamName}`} className="w-6 h-6 rounded-full mr-3 shadow-sm" />
                                            {team.teamName}
                                        </div>
                                    </td>
                                    <td className="px-4 py-4 whitespace-nowrap text-sm text-center text-gray-600 dark:text-gray-300">{team.played}</td>
                                    <td className="px-4 py-4 whitespace-nowrap text-sm text-center text-gray-600 dark:text-gray-300">{team.wins}</td>
                                    <td className="px-4 py-4 whitespace-nowrap text-sm text-center text-gray-600 dark:text-gray-300">{team.draws}</td>
                                    <td className="px-4 py-4 whitespace-nowrap text-sm text-center text-gray-600 dark:text-gray-300">{team.losses}</td>
                                    <td className="px-4 py-4 whitespace-nowrap text-sm text-center text-gray-600 dark:text-gray-300">{team.goalsFor}</td>
                                    <td className="px-4 py-4 whitespace-nowrap text-sm text-center text-gray-600 dark:text-gray-300">{team.goalsAgainst}</td>
                                    <td className="px-4 py-4 whitespace-nowrap text-sm text-center text-gray-600 dark:text-gray-300">{team.goalDifference}</td>
                                    <td className="px-4 py-4 whitespace-nowrap text-sm text-center font-bold text-gray-900 dark:text-white">{team.points}</td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            );
        };

        const TopScorersTable = ({ scorers }) => {
            if (scorers.length === 0) {
                return <p className="text-center text-gray-500 dark:text-gray-400 py-4">No hay anotadores registrados.</p>;
            }
            return (
                <div className="overflow-x-auto rounded-xl shadow-lg bg-white dark:bg-gray-800">
                    <table className="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                        <thead className="bg-gray-50 dark:bg-gray-700/50">
                            <tr>
                                <th className="px-6 py-3 text-left text-xs font-bold text-gray-600 dark:text-gray-200 uppercase tracking-wider">Jugador</th>
                                <th className="px-6 py-3 text-left text-xs font-bold text-gray-600 dark:text-gray-200 uppercase tracking-wider">Equipo</th>
                                <th className="px-6 py-3 text-center text-xs font-bold text-gray-600 dark:text-gray-200 uppercase tracking-wider">Goles</th>
                            </tr>
                        </thead>
                        <tbody className="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                            {scorers.map((scorer, index) => (
                                <tr key={index} className="hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors duration-200">
                                    <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">{scorer.playerName}</td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-600 dark:text-gray-300">{scorer.teamName}</td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm font-bold text-center text-gray-900 dark:text-white">{scorer.goals}</td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            );
        };

        const ResultsList = ({ matches, getTeamName, getTeamLogo, onMatchClick }) => {
            const recentMatches = matches.filter(m => m.scoreHome !== null).sort((a, b) => new Date(b.date) - new Date(a.date));
            if (recentMatches.length === 0) {
                return <p className="text-center text-sm text-gray-500 dark:text-gray-400 py-4">No hay resultados recientes.</p>;
            }
            return (
                <div className="space-y-3 mt-4">
                    {recentMatches.map(match => (
                        <div key={match.id} onClick={() => onMatchClick(match)} className="bg-white dark:bg-gray-800/70 p-3 rounded-lg hover:shadow-lg hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer transition-all duration-200 shadow-md">
                            <p className="text-xs text-gray-500 dark:text-gray-400">{new Date(match.date).toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
                            <div className="flex items-center justify-between mt-1">
                                <div className="flex-1 text-sm font-bold flex items-center">
                                    <img src={getTeamLogo(match.homeTeamId)} className="w-5 h-5 rounded-full mr-2 shadow-sm" />
                                    {getTeamName(match.homeTeamId)}
                                </div>
                                <span className="text-lg font-extrabold mx-3 text-[#101097] dark:text-blue-300">{match.scoreHome} - {match.scoreAway}</span>
                                <div className="flex-1 text-sm font-bold flex items-center justify-end text-right">
                                    {getTeamName(match.awayTeamId)}
                                    <img src={getTeamLogo(match.awayTeamId)} className="w-5 h-5 rounded-full ml-2 shadow-sm" />
                                </div>
                            </div>
                            {match.status === 'Anulado' && <p className="text-center text-xs text-[#CE0E2D] dark:text-red-400 font-bold mt-1">PARTIDO ANULADO</p>}
                        </div>
                    ))}
                </div>
            );
        };

        const MatchDetailsModal = ({ match, onClose, getPlayerName, getTeamName }) => {
            if (!match) return null;
            const homeScorers = match.scorers?.filter(s => s.teamId === match.homeTeamId) || [];
            const awayScorers = match.scorers?.filter(s => s.teamId === match.awayTeamId) || [];
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60 backdrop-blur-sm" onClick={onClose}>
                    <div className="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-2xl max-w-md w-full text-left border-t-4 border-[#101097]" onClick={e => e.stopPropagation()}>
                        <div className="text-center mb-4">
                            <p className="text-sm text-gray-500 dark:text-gray-400">{new Date(match.date).toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
                            <h3 className="text-2xl font-bold">{getTeamName(match.homeTeamId)} <span className="text-[#101097] dark:text-blue-300">{match.scoreHome} - {match.scoreAway}</span> {getTeamName(match.awayTeamId)}</h3>
                        </div>
                        <h4 className="text-lg font-semibold mb-2 border-b pb-1">Anotadores</h4>
                        {match.scorers?.length > 0 ? (
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <h5 className="font-bold">{getTeamName(match.homeTeamId)}</h5>
                                    <ul className="list-disc pl-5 space-y-1">
                                        {homeScorers.map((scorer, i) => <li key={i}>{getPlayerName(scorer.playerId)} ({scorer.count})</li>)}
                                    </ul>
                                    {homeScorers.length === 0 && <p className="text-sm text-gray-400">Sin anotadores.</p>}
                                </div>
                                <div>
                                    <h5 className="font-bold">{getTeamName(match.awayTeamId)}</h5>
                                    <ul className="list-disc pl-5 space-y-1">
                                        {awayScorers.map((scorer, i) => <li key={i}>{getPlayerName(scorer.playerId)} ({scorer.count})</li>)}
                                    </ul>
                                     {awayScorers.length === 0 && <p className="text-sm text-gray-400">Sin anotadores.</p>}
                                </div>
                            </div>
                        ) : (
                            <p className="text-center text-gray-500 dark:text-gray-400 py-3">No se registraron anotadores para este partido.</p>
                        )}
                        <div className="text-right mt-6">
                            <button onClick={onClose} className="btn-primary">Cerrar</button>
                        </div>
                    </div>
                </div>
            );
        };

        const EditTeamModal = ({ team, onClose, onSave, showMessage }) => {
            if (!team) return null;

            const [name, setName] = useState(team.name);
            const [logoUrl, setLogoUrl] = useState(team.logoUrl);

            const handleSave = () => {
                if (!name.trim() || !logoUrl.trim()) {
                    showMessage("El nombre y la URL del logo no pueden estar vac√≠os.");
                    return;
                }
                onSave(team.id, name, logoUrl);
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60 backdrop-blur-sm">
                    <div className="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-2xl max-w-md w-full text-left border-t-4 border-[#101097]">
                        <h3 className="text-xl font-bold mb-4">Editar Equipo</h3>
                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 dark:text-gray-300">Nombre del Equipo</label>
                                <input
                                    type="text"
                                    value={name}
                                    onChange={(e) => setName(e.target.value)}
                                    className="w-full mt-1 p-2 rounded-lg border dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white"
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700 dark:text-gray-300">URL del Logo</label>
                                <input
                                    type="text"
                                    value={logoUrl}
                                    onChange={(e) => setLogoUrl(e.target.value)}
                                    className="w-full mt-1 p-2 rounded-lg border dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white"
                                />
                            </div>
                        </div>
                        <div className="flex justify-end space-x-2 mt-6">
                            <button onClick={onClose} className="py-2 px-5 bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-white font-semibold rounded-lg shadow-md hover:bg-gray-300 dark:hover:bg-gray-500 transition-all">Cancelar</button>
                            <button onClick={handleSave} className="btn-primary">Guardar Cambios</button>
                        </div>
                    </div>
                </div>
            );
        };

        const AddPlayersModal = ({ team, onClose, onAdd, showMessage }) => {
            if (!team) return null;

            const [playerNames, setPlayerNames] = useState('');

            const handleAdd = () => {
                const names = playerNames.split('\n').map(name => name.trim()).filter(name => name);
                if (names.length === 0) {
                    showMessage("Por favor, introduce al menos un nombre de jugador.");
                    return;
                }
                onAdd(team.id, names);
                setPlayerNames('');
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60 backdrop-blur-sm">
                    <div className="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-2xl max-w-md w-full text-left border-t-4 border-[#101097]">
                        <h3 className="text-xl font-bold mb-2">A√±adir Jugadores a <span className="text-[#101097]">{team.name}</span></h3>
                        <p className="text-sm text-gray-500 dark:text-gray-400 mb-4">Escribe un nombre por l√≠nea. Puedes pegar una lista desde Excel o un editor de texto.</p>
                        <textarea
                            value={playerNames}
                            onChange={(e) => setPlayerNames(e.target.value)}
                            rows="10"
                            className="w-full mt-1 p-2 rounded-lg border dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white"
                            placeholder="Juan P√©rez\nMaria Garc√≠a\n..."
                        />
                        <div className="flex justify-end space-x-2 mt-6">
                            <button onClick={onClose} className="py-2 px-5 bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-white font-semibold rounded-lg shadow-md hover:bg-gray-300 dark:hover:bg-gray-500 transition-all">Cancelar</button>
                            <button onClick={handleAdd} className="btn-primary">A√±adir Jugadores</button>
                        </div>
                    </div>
                </div>
            );
        };

        const MatchesView = ({ matches, getTeamName, appId, db, showMessage, leagues, teams, players, getLeagueName, getPlayersByTeam, selectedDateFilter, selectedLeagueFilter }) => {
            const [selectedMatch, setSelectedMatch] = useState(null);
            const [scoreHome, setScoreHome] = useState(0);
            const [scoreAway, setScoreAway] = useState(0);
            const [scorers, setScorers] = useState([]);
            const [isEditing, setIsEditing] = useState(false);

            const handleEditMatch = (match) => {
                setSelectedMatch(match);
                setScoreHome(match.scoreHome !== null ? match.scoreHome : 0);
                setScoreAway(match.scoreAway !== null ? match.scoreAway : 0);
                setScorers(match.scorers || []);
                setIsEditing(true);
            };

            const handleSaveMatch = async () => {
                if (!selectedMatch) return;
                try {
                    const { doc, setDoc } = window.firebaseModules;
                    await setDoc(doc(db, `artifacts/${appId}/public/data/matches`, selectedMatch.id), {
                        ...selectedMatch,
                        scoreHome: parseInt(scoreHome, 10),
                        scoreAway: parseInt(scoreAway, 10),
                        scorers,
                    });
                    setIsEditing(false);
                    setSelectedMatch(null);
                    showMessage("Partido actualizado con √©xito.");
                } catch (e) {
                    console.error("Error al guardar el partido:", e);
                    showMessage("Error al guardar el partido.");
                }
            };

            const handleAddScorer = (teamId) => {
                setScorers(prev => [...prev, { playerId: '', teamId, count: 1 }]);
            };

            const handleScorerChange = (index, field, value) => {
                const newScorers = [...scorers];
                newScorers[index][field] = value;
                setScorers(newScorers);
            };

            const handleRemoveScorer = (index) => {
                setScorers(prev => prev.filter((_, i) => i !== index));
            };

            const handleNullifyMatch = async () => {
                if (!selectedMatch) return;
                if (confirm("¬øEst√°s seguro de que quieres anular este partido? Se registrar√° como un empate 0-0 y se borrar√°n los goleadores.")) {
                    try {
                        const { doc, setDoc } = window.firebaseModules;
                        await setDoc(doc(db, `artifacts/${appId}/public/data/matches`, selectedMatch.id), {
                            ...selectedMatch,
                            scoreHome: 0,
                            scoreAway: 0,
                            scorers: [],
                            status: 'Anulado'
                        });
                        setIsEditing(false);
                        setSelectedMatch(null);
                        showMessage("Partido anulado con √©xito (Empate 0-0).");
                    } catch (e) {
                        console.error("Error al anular el partido:", e);
                        showMessage("Error al anular el partido.");
                    }
                }
            };

            const filteredMatches = matches.filter(match => {
                const dateMatch = selectedDateFilter ? match.date === selectedDateFilter : true;
                const leagueMatch = selectedLeagueFilter ? match.leagueId === selectedLeagueFilter : true;
                return dateMatch && leagueMatch;
            });

            const sortedMatches = [...filteredMatches].sort((a, b) => new Date(a.date) - new Date(b.date));

            return (
                <div className="space-y-4">
                    {isEditing && selectedMatch ? (
                        <div className="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg space-y-4 border-t-4 border-[#101097]">
                            <h4 className="text-xl font-bold">Editar Partido</h4>
                            <p className="text-gray-500 dark:text-gray-400">
                                {getLeagueName(selectedMatch.leagueId)}
                                <br />
                                {getTeamName(selectedMatch.homeTeamId)} vs {getTeamName(selectedMatch.awayTeamId)} - {selectedMatch.date}
                            </p>
                            <div className="flex items-center space-x-4">
                                <label className="text-sm font-medium">Marcador Local:</label>
                                <input type="number" min="0" value={scoreHome} onChange={(e) => setScoreHome(Math.max(0, parseInt(e.target.value, 10)))} className="w-20 p-2 rounded-lg border dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white" />
                                <label className="text-sm font-medium">Marcador Visitante:</label>
                                <input type="number" min="0" value={scoreAway} onChange={(e) => setScoreAway(Math.max(0, parseInt(e.target.value, 10)))} className="w-20 p-2 rounded-lg border dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white" />
                            </div>
                            <div className="space-y-2">
                                <h5 className="text-lg font-semibold">Goleadores</h5>
                                <div className="flex space-x-2">
                                    <button onClick={() => handleAddScorer(selectedMatch.homeTeamId)} className="btn-primary text-sm py-1 px-3">+ Goleador Local</button>
                                    <button onClick={() => handleAddScorer(selectedMatch.awayTeamId)} className="btn-primary text-sm py-1 px-3">+ Goleador Visitante</button>
                                </div>
                                {scorers.map((scorer, index) => (
                                    <div key={index} className="flex items-center space-x-2 bg-gray-50 dark:bg-gray-700/50 p-2 rounded-lg">
                                        <select value={scorer.playerId} onChange={(e) => handleScorerChange(index, 'playerId', e.target.value)} className="p-2 rounded-lg border dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white flex-1">
                                            <option value="">Selecciona un jugador</option>
                                            {getPlayersByTeam(scorer.teamId).map(p => <option key={p.id} value={p.id}>{p.name}</option>)}
                                        </select>
                                        <input type="number" min="1" value={scorer.count} onChange={(e) => handleScorerChange(index, 'count', parseInt(e.target.value, 10))} className="w-16 p-2 rounded-lg border dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white" />
                                        <button onClick={() => handleRemoveScorer(index)} className="text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-100 dark:hover:bg-red-900/50 transition-colors"><TrashIcon /></button>
                                    </div>
                                ))}
                            </div>
                            <div className="flex justify-end space-x-2 pt-4 border-t dark:border-gray-700">
                                <button onClick={handleNullifyMatch} className="btn-danger">Anular (0-0)</button>
                                <button onClick={() => setIsEditing(false)} className="py-2 px-5 bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-white font-semibold rounded-lg shadow-md hover:bg-gray-300 dark:hover:bg-gray-500 transition-all duration-300">Cancelar</button>
                                <button onClick={handleSaveMatch} className="btn-primary">Guardar Cambios</button>
                            </div>
                        </div>
                    ) : (
                        <div className="space-y-4">
                            {leagues.length === 0 ? (
                                <p className="text-center text-gray-500 dark:text-gray-400 py-8">No hay partidos para mostrar. Por favor, crea las ligas y genera el calendario.</p>
                            ) : (
                                sortedMatches.map(match => (
                                    <div key={match.id} className="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-lg flex items-center justify-between hover:shadow-xl transition-all duration-300">
                                        <div>
                                            <p className="font-semibold text-lg flex items-center text-[#101097] dark:text-blue-300">
                                                <SportIcon sport={leagues.find(l => l.id === match.leagueId)?.sport} />
                                                {getLeagueName(match.leagueId)}
                                            </p>
                                            <p className="text-gray-500 dark:text-gray-400 text-sm">{match.date}</p>
                                            <p className="text-gray-900 dark:text-white font-bold text-xl mt-1">
                                                {getTeamName(match.homeTeamId)} vs {getTeamName(match.awayTeamId)}
                                            </p>
                                            {match.status === 'Anulado' && <p className="text-[#CE0E2D] dark:text-red-400 font-bold text-sm mt-1">PARTIDO ANULADO</p>}
                                            {match.scoreHome !== null && <p className="text-gray-700 dark:text-gray-300 font-bold text-lg">Marcador: {match.scoreHome} - {match.scoreAway}</p>}
                                        </div>
                                        <button onClick={() => handleEditMatch(match)} className="text-[#101097] hover:text-[#001E61] dark:text-blue-300 dark:hover:text-blue-200 p-2 rounded-full hover:bg-blue-50 dark:hover:bg-blue-900/50 transition-colors"><EditIcon /></button>
                                    </div>
                                ))
                            )}
                        </div>
                    )}
                </div>
            );
        };

        const LeagueCard = ({ league, teams, players, appId, db, showMessage, onMatchDayChange, onEditTeam, onAddPlayers, onAddNewTeam }) => {
            const [isExpanded, setIsExpanded] = useState(false);
            const dayOptions = [ { value: 1, label: 'Lunes' }, { value: 2, label: 'Martes' }, { value: 3, label: 'Mi√©rcoles' }, { value: 4, label: 'Jueves' }, { value: 5, label: 'Viernes' }, { value: 6, label: 'S√°bado' }, { value: 0, label: 'Domingo' } ];

            const handleDeletePlayer = async (playerId) => {
                if (confirm("¬øEst√°s seguro de que quieres eliminar a este jugador?")) {
                    const { doc, deleteDoc } = window.firebaseModules;
                    try {
                        await deleteDoc(doc(db, `artifacts/${appId}/public/data/players`, playerId));
                        showMessage("Jugador eliminado con √©xito.");
                    } catch (e) { console.error("Error al eliminar jugador:", e); showMessage("Error al eliminar jugador."); }
                }
            };

            return (
                <div className="bg-gray-50 dark:bg-gray-800/50 p-4 rounded-xl shadow-inner transition-all duration-300">
                    <div className="flex items-center justify-between">
                        <h4 className="text-xl font-semibold text-gray-900 dark:text-white flex items-center">
                            <SportIcon sport={league.sport} />
                            {league.name}
                        </h4>
                        <div className="flex items-center space-x-2">
                            <select value={league.matchDay ?? ''} onChange={(e) => onMatchDayChange(league.id, e.target.value)} className="p-2 rounded-lg border dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm" onClick={(e) => e.stopPropagation()}>
                                <option value="">-- Asignar D√≠a --</option>
                                {dayOptions.map(day => <option key={day.value} value={day.value}>{day.label}</option>)}
                            </select>
                            <button onClick={() => setIsExpanded(!isExpanded)} className="text-[#101097] hover:text-[#001E61] dark:text-blue-300 dark:hover:text-blue-200 p-1">{isExpanded ? <ChevronUpIcon className="w-6 h-6" /> : <ChevronDownIcon className="w-6 h-6" />}</button>
                        </div>
                    </div>
                    {isExpanded && (
                        <div className="mt-4 space-y-4">
                            {teams.map(team => (
                                <div key={team.id} className="bg-white dark:bg-gray-800 p-4 rounded-xl shadow space-y-2">
                                    <div className="flex items-center justify-between">
                                        <div className="flex items-center space-x-2">
                                            <img src={team.logoUrl} alt={`Logo de ${team.name}`} className="w-8 h-8 rounded-full shadow-md" />
                                            <span className="font-medium">{team.name}</span>
                                            <button onClick={() => onEditTeam(team)} className="text-blue-500 hover:text-blue-700 p-1 rounded-full hover:bg-blue-100 dark:hover:bg-blue-900/50 transition-colors">
                                                <EditIcon className="w-4 h-4" />
                                            </button>
                                        </div>
                                        <button onClick={() => onAddPlayers(team)} className="btn-primary text-xs py-1 px-3">A√±adir Jugadores</button>
                                    </div>
                                    <ul className="list-disc pl-6 text-gray-600 dark:text-gray-300 space-y-1">
                                        {players.filter(p => p.teamId === team.id).length > 0 ? (
                                            players.filter(p => p.teamId === team.id).map(player => (
                                                <li key={player.id} className="flex items-center justify-between">
                                                    <span>{player.name}</span>
                                                    <button onClick={() => handleDeletePlayer(player.id)} className="text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-100 dark:hover:bg-red-900/50 transition-colors"><TrashIcon className="w-4 h-4" /></button>
                                                </li>
                                            ))
                                        ) : (
                                            <li>No hay jugadores en este equipo.</li>
                                        )}
                                    </ul>
                                </div>
                            ))}
                            <div className="pt-4 mt-4 border-t border-gray-200 dark:border-gray-700 flex justify-center">
                                <button onClick={() => onAddNewTeam(league.id)} className="btn-primary flex items-center text-sm py-2 px-4">
                                    <PlusIcon className="w-4 h-4 mr-2" />
                                    A√±adir Nuevo Equipo
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const App = () => {
            const [view, setView] = useState('standings');
            const [tournaments, setTournaments] = useState([]);
            const [selectedTournamentId, setSelectedTournamentId] = useState('');
            const [leagues, setLeagues] = useState([]);
            const [teams, setTeams] = useState([]);
            const [players, setPlayers] = useState([]);
            const [matches, setMatches] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [user, setUser] = useState(null);
            const [appId, setAppId] = useState(null);
            const [showModal, setShowModal] = useState(false);
            const [modalMessage, setModalMessage] = useState('');
            const [selectedSport, setSelectedSport] = useState('F√∫tbol');
            const [isAuthReady, setIsAuthReady] = useState(false);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [selectedDateFilter, setSelectedDateFilter] = useState('');
            const [selectedLeagueFilter, setSelectedLeagueFilter] = useState('');
            const [selectedStandingsLeagueFilter, setSelectedStandingsLeagueFilter] = useState('');
            const [upcomingMatchesDate, setUpcomingMatchesDate] = useState('');
            const [refereeMatchDate, setRefereeMatchDate] = useState('');
            const [scheduleStartDate, setScheduleStartDate] = useState('');
            const [scheduleEndDate, setScheduleEndDate] = useState('');
            const [matchDetails, setMatchDetails] = useState(null);
            const [editingTeam, setEditingTeam] = useState(null);
            const [addingPlayersTeam, setAddingPlayersTeam] = useState(null);
            const [selectedTeam, setSelectedTeam] = useState(null);

            const showMessage = (message) => { setModalMessage(message); setShowModal(true); };
            const handleMatchClick = (match) => { setMatchDetails(match); };
            const handleTeamClick = (teamId) => {
                const team = teams.find(t => t.id === teamId);
                if (team) {
                    setSelectedTeam(team);
                }
            };

            const getTeamName = useCallback((teamId) => teams.find(t => t.id === teamId)?.name || 'Equipo Desconocido', [teams]);
            const getTeamLogo = useCallback((teamId) => teams.find(t => t.id === teamId)?.logoUrl || '', [teams]);
            const getPlayerName = useCallback((playerId) => players.find(p => p.id === playerId)?.name || 'Jugador Desconocido', [players]);

            useEffect(() => {
                const initFirebase = async () => {
                    try {
                        const { initializeApp, getAuth, onAuthStateChanged, getFirestore } = window.firebaseModules;
                        const firebaseConfig = { apiKey: "AIzaSyBHX9ezfBiEZhxIDZTr-OTB5hgKV-zt0G4", authDomain: "torneos-lasalle-2.firebaseapp.com", projectId: "torneos-lasalle-2", storageBucket: "torneos-lasalle-2.firebasestorage.app", messagingSenderId: "860168864523", appId: "1:860168864523:web:1da5a47fa8ccb20def980e" };
                        const app = initializeApp(firebaseConfig);
                        const auth = getAuth(app);
                        setAppId('lasalle-secundaria-deportes'); // ID para la base de datos de Secundaria
                        window.firebaseApp = { ...window.firebaseApp, app, auth, db: getFirestore(app) };

                        onAuthStateChanged(auth, (user) => {
                            setUser(user);
                            setIsAuthReady(true);
                            setIsLoading(false);
                        });
                    } catch (e) {
                        console.error("Firebase init error", e);
                        setIsLoading(false);
                        document.getElementById('root').innerHTML = `<div class="p-8 text-center text-red-500">Error: No se pudo cargar Firebase.</div>`;
                    }
                };
                initFirebase();
            }, []);

            useEffect(() => {
                if (!isAuthReady || !appId) return;
                
                const publicDataPath = `artifacts/${appId}/public/data`;

                const { collection, onSnapshot } = window.firebaseModules;
                const db = window.firebaseApp.db;
                const collections = ['tournaments', 'leagues', 'teams', 'players', 'matches'];
                const setters = { tournaments: setTournaments, leagues: setLeagues, teams: setTeams, players: setPlayers, matches: setMatches };

                const unsubscribers = collections.map(col =>
                    onSnapshot(collection(db, `${publicDataPath}/${col}`), (snapshot) => {
                        const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        if (col === 'tournaments') {
                            data.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                            setTournaments(data);
                            if (data.length > 0 && (!selectedTournamentId || !data.find(t => t.id === selectedTournamentId))) {
                                setSelectedTournamentId(data[0].id);
                            } else if (data.length === 0) {
                                setSelectedTournamentId('');
                            }
                        } else {
                            setters[col](data);
                        }
                    })
                );
                return () => unsubscribers.forEach(unsub => unsub());
            }, [appId, isAuthReady, selectedTournamentId]);

            const handleLogin = async () => {
                const { signInWithEmailAndPassword } = window.firebaseModules;
                const auth = window.firebaseApp.auth;
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    showMessage("Inicio de sesi√≥n exitoso.");
                } catch (error) {
                    showMessage("Error al iniciar sesi√≥n: " + error.message);
                }
            };

            const handleLogout = async () => {
                const { signOut } = window.firebaseModules;
                const auth = window.firebaseApp.auth;
                try {
                    await signOut(auth);
                    showMessage("Sesi√≥n cerrada.");
                } catch (error) {
                    showMessage("Error al cerrar sesi√≥n: " + error.message);
                }
            };

            const handleMatchDayChange = async (leagueId, day) => {
                if (!user || !appId) return;
                const { doc, updateDoc } = window.firebaseModules;
                try {
                    await updateDoc(doc(window.firebaseApp.db, `artifacts/${appId}/public/data/leagues`, leagueId), { matchDay: day ? parseInt(day, 10) : null });
                } catch (e) { console.error("Error updating match day:", e); showMessage("Error al actualizar el d√≠a."); }
            };

            const handleEditTeam = (team) => {
                setEditingTeam(team);
            };

            const handleCloseEditTeam = () => {
                setEditingTeam(null);
            };

            const handleUpdateTeam = async (teamId, name, logoUrl) => {
                if (!user || !appId) return;
                const { doc, updateDoc } = window.firebaseModules;
                try {
                    await updateDoc(doc(window.firebaseApp.db, `artifacts/${appId}/public/data/teams`, teamId), { name, logoUrl });
                    showMessage("Equipo actualizado con √©xito.");
                    handleCloseEditTeam();
                } catch (e) {
                    console.error("Error updating team:", e); showMessage("Error al actualizar el equipo.");
                }
            };

            const handleOpenAddPlayersModal = (team) => {
                setAddingPlayersTeam(team);
            };

            const handleAddMultiplePlayers = async (teamId, names) => {
                if (!user || !appId) return;
                const { db } = window.firebaseApp;
                const { doc, setDoc } = window.firebaseModules;
                
                const playerPromises = names.map(name => {
                    const playerId = crypto.randomUUID();
                    return setDoc(doc(db, `artifacts/${appId}/public/data/players`, playerId), { id: playerId, name, teamId });
                });

                try {
                    await Promise.all(playerPromises);
                    showMessage(`${names.length} jugador(es) a√±adido(s) con √©xito.`);
                    setAddingPlayersTeam(null); // Close modal on success
                } catch (e) {
                    console.error("Error adding multiple players:", e);
                    showMessage("Error al a√±adir los jugadores.");
                }
            };

            const handleAddNewTeam = async (leagueId) => {
                if (!user || !appId) return;
                const teamName = prompt("Introduce el nombre del nuevo equipo:");
                if (!teamName || !teamName.trim()) return;

                setIsLoading(true);
                const { db } = window.firebaseApp;
                const { doc, setDoc } = window.firebaseModules;
                
                const teamsInLeague = teams.filter(t => t.leagueId === leagueId).length;
                const teamId = crypto.randomUUID();
                const newTeam = {
                    id: teamId,
                    name: teamName.trim(),
                    leagueId,
                    logoUrl: `https://placehold.co/100x100/A0A0A0/FFF?text=${teamsInLeague + 1}`
                };

                try {
                    await setDoc(doc(db, `artifacts/${appId}/public/data/teams`, teamId), newTeam);
                    showMessage(`Equipo "${teamName.trim()}" a√±adido con √©xito.`);
                } catch (e) {
                    console.error("Error adding new team:", e);
                    showMessage("Error al a√±adir el equipo.");
                }
                setIsLoading(false);
            };

            const handleDeleteTournament = async () => {
                if (!selectedTournamentId) {
                    showMessage("Por favor, selecciona un torneo para eliminar.");
                    return;
                }

                if (confirm(`¬øEst√°s seguro de que quieres eliminar el torneo '${tournaments.find(t => t.id === selectedTournamentId)?.name}' y TODOS sus datos (ligas, equipos, jugadores, partidos)? Esta acci√≥n es irreversible.`)) {
                    setIsLoading(true);
                    const { db } = window.firebaseApp;
                    const { collection, query, where, getDocs, doc, deleteDoc } = window.firebaseModules;
                    
                    try {
                        const leaguesQuery = query(collection(db, `artifacts/${appId}/public/data/leagues`), where("tournamentId", "==", selectedTournamentId));
                        const leaguesSnapshot = await getDocs(leaguesQuery);
                        const leagueIds = leaguesSnapshot.docs.map(d => d.id);

                        if (leagueIds.length > 0) {
                            const teamsQuery = query(collection(db, `artifacts/${appId}/public/data/teams`), where("leagueId", "in", leagueIds));
                            const teamsSnapshot = await getDocs(teamsQuery);
                            const teamIds = teamsSnapshot.docs.map(d => d.id);

                            if (teamIds.length > 0) {
                                const playersQuery = query(collection(db, `artifacts/${appId}/public/data/players`), where("teamId", "in", teamIds));
                                const playersSnapshot = await getDocs(playersQuery);
                                await Promise.all(playersSnapshot.docs.map(d => deleteDoc(d.ref)));
                            }
                            await Promise.all(teamsSnapshot.docs.map(d => deleteDoc(d.ref)));

                            const matchesQuery = query(collection(db, `artifacts/${appId}/public/data/matches`), where("leagueId", "in", leagueIds));
                            const matchesSnapshot = await getDocs(matchesQuery);
                            await Promise.all(matchesSnapshot.docs.map(d => deleteDoc(d.ref)));
                        }
                        
                        await Promise.all(leaguesSnapshot.docs.map(d => deleteDoc(d.ref)));

                        await deleteDoc(doc(db, `artifacts/${appId}/public/data/tournaments`, selectedTournamentId));

                        showMessage("Torneo eliminado con √©xito.");
                    } catch (e) {
                        console.error("Error deleting tournament:", e);
                        showMessage("Error al eliminar el torneo.");
                    } finally {
                        setIsLoading(false);
                    }
                }
            };

            const handleDeleteSchedule = async (visibleLeagueIds) => {
                if (confirm("¬øEst√°s seguro de que quieres borrar TODO el calendario para el torneo actual? Esta acci√≥n no se puede deshacer.")) {
                    if (!user || !appId || visibleLeagueIds.length === 0) return;
                    setIsLoading(true);
                    const { db } = window.firebaseApp;
                    const { collection, getDocs, query, where, deleteDoc } = window.firebaseModules;
                    try {
                        const q = query(collection(db, `artifacts/${appId}/public/data/matches`), where("leagueId", "in", visibleLeagueIds));
                        const existingMatches = await getDocs(q);
                        await Promise.all(existingMatches.docs.map(matchDoc => deleteDoc(matchDoc.ref)));
                        showMessage("Calendario del torneo actual borrado.");
                    } catch (e) { console.error("Error deleting schedule:", e); showMessage("Error al borrar el calendario."); } 
                    setIsLoading(false);
                }
            };

            const createLeaguesAndTeams = async () => {
                if (!user || !appId) return;
                const tournamentName = prompt(`Introduce un nombre para el nuevo torneo de ${selectedSport}:`, `Torneo ${selectedSport} ${new Date().getFullYear()}`);
                if (!tournamentName) return;

                setIsLoading(true);
                const { db } = window.firebaseApp;
                const { collection, doc, setDoc } = window.firebaseModules;
                const leagueNames = ['Grupos A Varonil', 'Grupos A Femenil', 'Grupos B Varonil', 'Grupos B Femenil'];
                const tournamentId = crypto.randomUUID();
                const newTournament = { id: tournamentId, name: tournamentName, sport: selectedSport, createdAt: new Date().toISOString() };

                try {
                    await setDoc(doc(db, `artifacts/${appId}/public/data/tournaments`, tournamentId), newTournament);

                    for (const name of leagueNames) {
                        const leagueId = crypto.randomUUID();
                        await setDoc(doc(db, `artifacts/${appId}/public/data/leagues`, leagueId), { id: leagueId, name, sport: selectedSport, tournamentId });
                        const teamsInLeague = 4;
                        for (let i = 1; i <= teamsInLeague; i++) {
                            const teamName = `Equipo ${i}`;
                            const teamId = crypto.randomUUID();
                            await setDoc(doc(db, `artifacts/${appId}/public/data/teams`, teamId), {
                                id: teamId,
                                name: teamName,
                                leagueId,
                                logoUrl: `https://placehold.co/100x100/A0A0A0/FFF?text=${i}`
                            });
                        }
                    }
                    showMessage(`Torneo "${tournamentName}" creado con √©xito.`);
                } catch (e) { console.error("Error creating tournament:", e); showMessage("Error al crear el torneo."); }
                setIsLoading(false);
            };

            const generateSchedule = async (visibleLeagues, visibleTeams, isInitial) => {
                if (isInitial && !scheduleStartDate) {
                    showMessage("Selecciona una fecha de inicio para el calendario base.");
                    return;
                }
                if (!isInitial && !scheduleEndDate) {
                    showMessage("Selecciona una fecha de fin para extender el calendario.");
                    return;
                }

                setIsLoading(true);
                const { db } = window.firebaseApp;
                const { collection, doc, setDoc, getDocs, query, where, deleteDoc } = window.firebaseModules;
                const matchesRef = collection(db, `artifacts/${appId}/public/data/matches`);
                const newMatches = [];

                const leaguesWithoutDay = visibleLeagues.filter(l => l.matchDay == null).map(l => l.name).join(', ');
                if (leaguesWithoutDay) showMessage(`Ligas ignoradas por no tener d√≠a asignado: ${leaguesWithoutDay}`);

                try {
                    const visibleLeagueIds = visibleLeagues.map(l => l.id);
                    
                    if (isInitial) {
                        const q = query(matchesRef, where("leagueId", "in", visibleLeagueIds));
                        const existingMatches = await getDocs(q);
                        await Promise.all(existingMatches.docs.map(matchDoc => deleteDoc(matchDoc.ref)));
                    }

                    let lastMatchDate = null;
                    if (!isInitial) {
                        const q = query(matchesRef, where("leagueId", "in", visibleLeagueIds));
                        const existingMatches = await getDocs(q);
                        if (!existingMatches.empty) {
                            const dates = existingMatches.docs.map(d => new Date(d.data().date));
                            lastMatchDate = new Date(Math.max.apply(null, dates));
                        }
                    }
                    
                    const startDate = lastMatchDate ? new Date(lastMatchDate) : new Date(scheduleStartDate);
                    if(!lastMatchDate) startDate.setMinutes(startDate.getMinutes() + startDate.getTimezoneOffset());

                    const endDate = isInitial ? null : new Date(scheduleEndDate);
                    if(endDate) endDate.setMinutes(endDate.getMinutes() + endDate.getTimezoneOffset());

                    visibleLeagues.forEach(league => {
                        if (league.matchDay == null) return;
                        let leagueTeams = visibleTeams.filter(team => team.leagueId === league.id);
                        if (leagueTeams.length < 2) return;
                        if (leagueTeams.length % 2 !== 0) leagueTeams.push({ id: 'bye', name: 'Descanso' });

                        const numRounds = leagueTeams.length - 1;
                        const roundsToGenerate = isInitial ? 2 : 10; 
                        
                        let currentRoundOffset = 0;
                        if (!isInitial && lastMatchDate) {
                           const allMatchesForLeague = matches.filter(m => m.leagueId === league.id).sort((a,b) => new Date(a.date) - new Date(b.date));
                           if(allMatchesForLeague.length > 0) {
                               const roundsPlayed = Math.ceil(allMatchesForLeague.length / (leagueTeams.length / 2));
                               currentRoundOffset = roundsPlayed;
                           }
                        }


                        for (let leg = 0; leg < roundsToGenerate; leg++) {
                            let roundTeams = [...leagueTeams];
                            const legOffset = isInitial ? leg : currentRoundOffset + leg;

                            for (let round = 0; round < numRounds; round++) {
                                let date = new Date(startDate);
                                if(isInitial) {
                                    const dayOffset = (league.matchDay - date.getDay() + 7) % 7;
                                    date.setDate(date.getDate() + dayOffset + (round * 7) + (leg * numRounds * 7));
                                } else {
                                    const baseDate = new Date(lastMatchDate);
                                    const dayOffset = (league.matchDay - baseDate.getDay() + 7) % 7;
                                    date = new Date(baseDate.setDate(baseDate.getDate() + dayOffset + 7 + (round * 7) + (leg * numRounds * 7) ));
                                }
                                
                                if (endDate && date > endDate) continue;

                                for (let i = 0; i < roundTeams.length / 2; i++) {
                                    const home = (legOffset % 2 === 0) ? roundTeams[i] : roundTeams[roundTeams.length - 1 - i];
                                    const away = (legOffset % 2 === 0) ? roundTeams[roundTeams.length - 1 - i] : roundTeams[i];
                                    if (home.id !== 'bye' && away.id !== 'bye') {
                                        newMatches.push({ id: crypto.randomUUID(), leagueId: league.id, homeTeamId: home.id, awayTeamId: away.id, date: date.toISOString().split('T')[0], scoreHome: null, scoreAway: null, scorers: [] });
                                    }
                                }
                                roundTeams.splice(1, 0, roundTeams.pop());
                            }
                        }
                    });
                    
                    if(newMatches.length > 0) {
                        await Promise.all(newMatches.map(match => setDoc(doc(matchesRef, match.id), match)));
                        showMessage(isInitial ? "Calendario base generado." : "Calendario extendido.");
                    } else {
                        showMessage("No se generaron nuevos partidos. La fecha de fin podr√≠a ser demasiado temprana.");
                    }

                } catch (e) { console.error("Error generating schedule:", e); showMessage("Error al generar el calendario."); } 
                setIsLoading(false);
            };

            const getLeagueName = (leagueId) => leagues.find(l => l.id === leagueId)?.name || 'Liga Desconocida';
            const getPlayersByTeam = (teamId) => players.filter(p => p.teamId === teamId);

            const calculateStandings = useCallback((leagueId, visibleTeams, visibleMatches) => {
                const leagueTeams = visibleTeams.filter(t => t.leagueId === leagueId);
                const leagueMatches = visibleMatches.filter(m => m.leagueId === leagueId && m.scoreHome !== null);
                const standingsMap = leagueTeams.reduce((acc, team) => ({ ...acc, [team.id]: { id: team.id, teamName: team.name, logoUrl: team.logoUrl, played: 0, wins: 0, draws: 0, losses: 0, points: 0, goalsFor: 0, goalsAgainst: 0, goalDifference: 0 } }), {});

                leagueMatches.forEach(match => {
                    const home = standingsMap[match.homeTeamId], away = standingsMap[match.awayTeamId];
                    if (!home || !away) return;
                    home.played++; away.played++;
                    home.goalsFor += match.scoreHome; home.goalsAgainst += match.scoreAway;
                    away.goalsFor += match.scoreAway; away.goalsAgainst += match.scoreHome;
                    if (match.scoreHome > match.scoreAway) { home.wins++; away.losses++; home.points += 3; }
                    else if (match.scoreHome < match.scoreAway) { away.wins++; home.losses++; away.points += 3; }
                    else { home.draws++; away.draws++; home.points++; away.points++; }
                    home.goalDifference = home.goalsFor - home.goalsAgainst;
                    away.goalDifference = away.goalsFor - away.goalsAgainst;
                });
                return Object.values(standingsMap).sort((a, b) => b.points - a.points || b.goalDifference - a.goalDifference);
            }, []);

            const sortLeagues = (a, b) => {
                const order = ['1ro Varonil', '1ro Femenil', '3ro Varonil', '3ro Femenil', 'Areas Varonil', 'Areas Femenil'];
                return order.indexOf(a.name) - order.indexOf(b.name);
            };

            const calculateTopScorers = useCallback((leagueId, visibleMatches, visiblePlayers, visibleTeams) => {
                const scorersMap = visibleMatches.filter(m => m.leagueId === leagueId).flatMap(m => m.scorers)
                    .reduce((acc, scorer) => {
                        const player = visiblePlayers.find(p => p.id === scorer.playerId);
                        if (player) {
                            const team = visibleTeams.find(t => t.id === player.teamId);
                            if(team) {
                                acc[scorer.playerId] = acc[scorer.playerId] || { playerName: player.name, teamName: team.name, logoUrl: team.logoUrl, goals: 0 };
                                acc[scorer.playerId].goals += scorer.count;
                            }
                        }
                        return acc;
                    }, {});
                return Object.values(scorersMap).sort((a, b) => b.goals - a.goals);
            }, []);

            const svgToPngDataUrl = (svgUrl) => {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    img.crossOrigin = 'anonymous';
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        canvas.width = img.width;
                        canvas.height = img.height;
                        ctx.drawImage(img, 0, 0);
                        const pngDataUrl = canvas.toDataURL('image/png');
                        resolve({ dataUrl: pngDataUrl, format: 'png' });
                    };
                    img.onerror = reject;
                    img.src = svgUrl;
                });
            };

            const urlToB64 = (url) => {
                if (!url) return Promise.resolve(null);
                return fetch(url)
                    .then(res => {
                        if (!res.ok) throw new Error(`HTTP error ${res.status}`);
                        const contentType = res.headers.get('content-type');
                        if (!contentType || !contentType.startsWith('image/')) {
                            throw new Error(`Invalid content-type: ${contentType}`);
                        }
                        
                        if (contentType.includes('svg')) {
                            return svgToPngDataUrl(url);
                        } else {
                            return res.blob().then(blob => {
                                return new Promise((resolve, reject) => {
                                    const reader = new FileReader();
                                    reader.onloadend = () => resolve({ dataUrl: reader.result, format: contentType.split('/')[1] });
                                    reader.onerror = reject;
                                    reader.readAsDataURL(blob);
                                });
                            });
                        }
                    })
                    .catch(e => {
                        console.error(`Error fetching or converting image from ${url}:`, e);
                        return null;
                    });
            };

            const generateTeamListPdf = async (visibleLeagues, visibleTeams, visiblePlayers) => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const schoolLogoUrl = 'https://i.imgur.com/dzDfAiQ.png';

                const schoolLogoResult = await urlToB64(schoolLogoUrl);

                for (const league of visibleLeagues.sort(sortLeagues)) {
                    doc.addPage();
                    let y = 20;

                    if (schoolLogoResult) {
                        doc.addImage(schoolLogoResult.dataUrl, schoolLogoResult.format.toUpperCase(), 15, 15, 20, 20);
                    }

                    doc.setFontSize(18).text(`Liga: ${league.name}`, doc.internal.pageSize.getWidth() / 2, y, { align: 'center' });
                    y += 20;

                    const teamsInLeague = visibleTeams.filter(t => t.leagueId === league.id);

                    for (const team of teamsInLeague) {
                        if (y > 250) { doc.addPage(); y = 20; }

                        const teamLogoResult = await urlToB64(team.logoUrl);
                        if (teamLogoResult) {
                            doc.addImage(teamLogoResult.dataUrl, teamLogoResult.format.toUpperCase(), 15, y - 5, 10, 10);
                        }
                        doc.setFontSize(14).text(team.name, 30, y);
                        y += 10;

                        const teamPlayers = visiblePlayers.filter(p => p.teamId === team.id);
                        if (teamPlayers.length > 0) {
                            doc.autoTable({
                                startY: y,
                                head: [['Jugadores']],
                                body: teamPlayers.map(p => [p.name]),
                                theme: 'grid',
                                headStyles: { fillColor: [22, 160, 133] },
                            });
                            y = doc.autoTable.previous.finalY + 10;
                        } else {
                            doc.setFontSize(10).text("No hay jugadores en este equipo.", 15, y);
                            y += 10;
                        }
                    }
                }

                doc.deletePage(1); // Eliminar la primera p√°gina en blanco
                doc.save(`lista_equipos_jugadores_${selectedTournamentId}.pdf`);
                showMessage("PDF de Lista de Equipos y Jugadores generado.");
            };

            const generateUpcomingMatchesPdf = async (visibleMatches) => {
                if (!upcomingMatchesDate) {
                    showMessage("Por favor, selecciona una fecha para el reporte.");
                    return;
                }

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const pageCenter = doc.internal.pageSize.getWidth() / 2;
                let y = 20;

                const tournamentName = tournaments.find(t => t.id === selectedTournamentId)?.name || 'TORNEO';
                doc.setFontSize(18).text(`PR√ìXIMOS PARTIDOS - ${tournamentName.toUpperCase()}`, pageCenter, y, { align: 'center' });
                y += 8;
                doc.setFontSize(14).text(`FECHA: ${upcomingMatchesDate}`, pageCenter, y, { align: 'center' });
                y += 15;

                const filteredMatches = visibleMatches.filter(match => match.date === upcomingMatchesDate);
                if (filteredMatches.length === 0) {
                    doc.setFontSize(12).text("No hay partidos programados para esta fecha.", pageCenter, y, { align: 'center' });
                    doc.save(`proximos_partidos_${upcomingMatchesDate}.pdf`);
                    return;
                }

                const matchesByLeague = filteredMatches.reduce((acc, match) => {
                    (acc[match.leagueId] = acc[match.leagueId] || []).push(match);
                    return acc;
                }, {});

                const sortedLeagueIds = Object.keys(matchesByLeague).sort((a, b) => {
                    const leagueA = getLeagueName(a);
                    const leagueB = getLeagueName(b);
                    return sortLeagues({name: leagueA}, {name: leagueB});
                });

                for (const leagueId of sortedLeagueIds) {
                    const leagueName = getLeagueName(leagueId);
                    const leagueMatches = matchesByLeague[leagueId];

                    if (y > 250) { doc.addPage(); y = 20; }

                    doc.setFontSize(12).setFont(undefined, 'bold').text(leagueName, 14, y);
                    y += 8;

                    for (const match of leagueMatches) {
                        if (y > 270) { doc.addPage(); y = 20; }

                        const [homeLogoResult, awayLogoResult] = await Promise.all([
                            urlToB64(getTeamLogo(match.homeTeamId)),
                            urlToB64(getTeamLogo(match.awayTeamId))
                        ]);

                        const logoSize = 8;
                        const verticalAlign = y - (logoSize / 2) - 1;

                        doc.setFontSize(10).setFont(undefined, 'normal');

                        if (homeLogoResult) {
                            doc.addImage(homeLogoResult.dataUrl, homeLogoResult.format.toUpperCase(), 20, verticalAlign, logoSize, logoSize);
                        }
                        doc.text(getTeamName(match.homeTeamId), 32, y);

                        doc.text('vs', pageCenter, y, { align: 'center' });

                        doc.text(getTeamName(match.awayTeamId), 178, y, { align: 'right' });
                        if (awayLogoResult) {
                            doc.addImage(awayLogoResult.dataUrl, awayLogoResult.format.toUpperCase(), 180, verticalAlign, logoSize, logoSize);
                        }

                        y += 12;
                    }
                    y += 5;
                }

                doc.save(`proximos_partidos_${upcomingMatchesDate}.pdf`);
                showMessage("PDF de Pr√≥ximos Partidos generado.");
            };

            const generateRefereeSheetPdf = async (visibleMatches, visiblePlayers) => {
                if (!refereeMatchDate) {
                    showMessage("Selecciona una fecha para la c√©dula.");
                    return;
                }
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const pageCenter = doc.internal.pageSize.getWidth() / 2;

                const filteredMatches = visibleMatches
                    .filter(match => match.date === refereeMatchDate)
                    .sort((a, b) => {
                        const leagueA = getLeagueName(a.leagueId);
                        const leagueB = getLeagueName(b.leagueId);
                        return sortLeagues({name: leagueA}, {name: leagueB});
                    });

                if (filteredMatches.length === 0) {
                    showMessage("No hay partidos para la fecha seleccionada.");
                    return;
                }

                let matchCount = 0;
                for (const match of filteredMatches) {
                    const isFirstOnPage = matchCount % 2 === 0;
                    if (matchCount > 0 && isFirstOnPage) doc.addPage();

                    const yOffset = isFirstOnPage ? 15 : 150;
                    let y = yOffset;

                    const [homeLogoResult, awayLogoResult] = await Promise.all([
                        urlToB64(getTeamLogo(match.homeTeamId)),
                        urlToB64(getTeamLogo(match.awayTeamId))
                    ]);

                    doc.setFontSize(16).text("C√©dula de Partido", pageCenter, y, { align: 'center' });
                    y += 8;
                    doc.setFontSize(10).text(`Liga: ${getLeagueName(match.leagueId)}`, 15, y);
                    doc.text(`Fecha: ${match.date}`, 195, y, { align: 'right' });
                    y += 5;
                    
                    doc.setLineWidth(0.5).line(15, y, 195, y);
                    y += 8;

                    if (homeLogoResult) {
                        doc.addImage(homeLogoResult.dataUrl, homeLogoResult.format.toUpperCase(), 45, y, 12, 12);
                    }
                    doc.setFontSize(11).text(getTeamName(match.homeTeamId), 60, y + 8);

                    doc.setFontSize(11).text("VS", pageCenter, y + 8, { align: 'center' });

                    if (awayLogoResult) {
                        doc.addImage(awayLogoResult.dataUrl, awayLogoResult.format.toUpperCase(), 153, y, 12, 12);
                    }
                    doc.setFontSize(11).text(getTeamName(match.awayTeamId), 148, y + 8, { align: 'right' });
                    
                    y += 20;

                    const homeTeamPlayers = getPlayersByTeam(match.homeTeamId).filter(p => visiblePlayers.some(vp => vp.id === p.id)).map(p => [p.name, '']);
                    const awayTeamPlayers = getPlayersByTeam(match.awayTeamId).filter(p => visiblePlayers.some(vp => vp.id === p.id)).map(p => [p.name, '']);

                    doc.autoTable({ startY: y, head: [['Jugadores Local', 'N']], body: homeTeamPlayers, theme: 'grid', margin: { left: 15, right: 110 }, styles: { fontSize: 8, cellPadding: 1 }, headStyles: { fillColor: [22, 160, 133], fontSize: 9 }, columnStyles: { 1: { cellWidth: 10 } } });
                    doc.autoTable({ startY: y, head: [['Jugadores Visitante', 'N']], body: awayTeamPlayers, theme: 'grid', margin: { left: 110, right: 15 }, styles: { fontSize: 8, cellPadding: 1 }, headStyles: { fillColor: [22, 160, 133], fontSize: 9 }, columnStyles: { 1: { cellWidth: 10 } } });

                    y = doc.autoTable.previous.finalY + 7;

                    doc.setFontSize(9).text("Marcador Final:", 15, y);
                    doc.rect(45, y - 3, 20, 7);
                    doc.text("Observaciones:", 75, y);
                    doc.rect(100, y - 3, 95, 12);
                    y += 15;
                    
                    doc.line(20, y, 80, y); doc.setFontSize(9).text("Firma √Årbitro", 40, y + 4);
                    doc.line(120, y, 180, y); doc.setFontSize(9).text("Firma Capit√°n", 140, y + 4);
                    
                    matchCount++;
                }

                doc.save(`cedula_arbitro_${refereeMatchDate}.pdf`);
                showMessage("C√©dula de √Årbitro generada.");
            };

            const generateStandingsAndTopScorersPdf = async (visibleLeagues, visibleTeams, visibleMatches, visiblePlayers) => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                let y = 10;
                doc.setFontSize(18).text(`Reporte de Torneo: ${tournaments.find(t => t.id === selectedTournamentId)?.name || ''}`, 10, y);
                y += 15;

                const allStandings = visibleLeagues.flatMap(l => calculateStandings(l.id, visibleTeams, visibleMatches));
                const allScorers = visibleLeagues.flatMap(l => calculateTopScorers(l.id, visibleMatches, visiblePlayers, visibleTeams));
                const allLogoUrls = [...new Set([...allStandings.map(t => t.logoUrl), ...allScorers.map(s => s.logoUrl)])].filter(Boolean);
                
                const logoResults = await Promise.all(allLogoUrls.map(url => urlToB64(url)));
                const logoMap = allLogoUrls.reduce((map, url, index) => {
                    map[url] = logoResults[index];
                    return map;
                }, {});

                for (const league of visibleLeagues.sort(sortLeagues)) {
                    if (y > 250) { doc.addPage(); y = 15; }
                    doc.setFontSize(16).text(`Liga: ${league.name}`, 14, y);
                    y += 10;

                    doc.setFontSize(14).text("Clasificaci√≥n:", 14, y);
                    y += 7;
                    const standings = calculateStandings(league.id, visibleTeams, visibleMatches);
                    if (standings.length > 0) {
                        doc.autoTable({
                            startY: y,
                            head: [['', 'Equipo', 'PJ', 'G', 'E', 'P', 'GF', 'GC', 'DG', 'Pts']],
                            body: standings.map(t => ['', t.teamName, t.played, t.wins, t.draws, t.losses, t.goalsFor, t.goalsAgainst, t.goalDifference, t.points]),
                            theme: 'grid',
                            columnStyles: { 0: { cellWidth: 12 } },
                            didDrawCell: (data) => {
                                if (data.section === 'body' && data.column.index === 0) {
                                    const team = standings[data.row.index];
                                    const logoResult = logoMap[team.logoUrl];
                                    if (logoResult) {
                                        doc.addImage(logoResult.dataUrl, logoResult.format.toUpperCase(), data.cell.x + 2, data.cell.y + 2, 8, 8);
                                    }
                                }
                            }
                        });
                        y = doc.autoTable.previous.finalY + 10;
                    } else { doc.text("No hay datos.", 14, y); y += 10; }

                    if (y > 250) { doc.addPage(); y = 15; }
                    doc.setFontSize(14).text("Tabla de Anotadores:", 14, y);
                    y += 7;
                    const scorers = calculateTopScorers(league.id, visibleMatches, visiblePlayers, visibleTeams);
                    if (scorers.length > 0) {
                        doc.autoTable({
                            startY: y,
                            head: [['', 'Jugador', 'Equipo', 'Goles']],
                            body: scorers.map(s => ['', s.playerName, s.teamName, s.goals]),
                            theme: 'grid',
                            columnStyles: { 0: { cellWidth: 12 } },
                            didDrawCell: (data) => {
                                if (data.section === 'body' && data.column.index === 0) {
                                    const scorer = scorers[data.row.index];
                                    const logoResult = logoMap[scorer.logoUrl];
                                    if (logoResult) {
                                        doc.addImage(logoResult.dataUrl, logoResult.format.toUpperCase(), data.cell.x + 2, data.cell.y + 2, 8, 8);
                                    }
                                }
                            }
                        });
                        y = doc.autoTable.previous.finalY + 10;
                    } else { doc.text("No hay datos.", 14, y); y += 10; }
                }
                doc.save(`reporte_torneo_${selectedTournamentId}.pdf`);
                showMessage("PDF de Reporte de Torneo generado.");
            };

            const visibleLeagues = leagues.filter(l => l.tournamentId === selectedTournamentId);
            const visibleLeagueIds = visibleLeagues.map(l => l.id);
            const visibleTeams = teams.filter(t => visibleLeagueIds.includes(t.leagueId));
            const visibleTeamIds = visibleTeams.map(t => t.id);
            const visiblePlayers = players.filter(p => visibleTeamIds.includes(p.teamId));
            const visibleMatches = matches.filter(m => visibleLeagueIds.includes(m.leagueId));

            const AdminPanel = ({ onAddNewTeam }) => (
                <div className="p-4 space-y-6">
                    <h2 className="text-3xl font-extrabold text-gray-900 dark:text-white mb-4">Panel de Administraci√≥n</h2>
                    
                    <div className="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg space-y-4 border-t-4 border-[#101097]">
                        <h3 className="text-2xl font-bold text-gray-900 dark:text-white">Seleccionar Torneo</h3>
                        {tournaments.length > 0 ? (
                            <div className="flex items-center space-x-4">
                                <select value={selectedTournamentId} onChange={(e) => setSelectedTournamentId(e.target.value)} className="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-[#101097] bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white transition-colors">
                                    {tournaments.map(t => <option key={t.id} value={t.id}>{t.name}</option>)}
                                </select>
                                <button onClick={handleDeleteTournament} className="btn-danger flex items-center"><TrashIcon className="inline-block w-5 h-5 mr-2" />Eliminar Torneo</button>
                            </div>
                        ) : (
                            <p className="text-center text-gray-500 dark:text-gray-400 py-4">No hay torneos creados. Crea uno para empezar.</p>
                        )}
                    </div>

                    <div className="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg space-y-4 border-t-4 border-[#101097]">
                        <h3 className="text-2xl font-bold text-gray-900 dark:text-white">Crear Nuevo Torneo</h3>
                        <p className="text-gray-600 dark:text-gray-300">Crear√° un nuevo torneo con su propio conjunto de ligas y equipos. Los torneos existentes no se ver√°n afectados.</p>
                        <div className="flex items-center space-x-4">
                            <div className="relative flex-grow">
                                <select id="sport-select" value={selectedSport} onChange={(e) => setSelectedSport(e.target.value)} className="w-full p-3 pl-10 pr-3 border border-gray-300 dark:border-gray-600 rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-[#101097] bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white transition-colors">
                                    {['F√∫tbol', 'B√°squetbol', 'Voleibol'].map(sport => <option key={sport} value={sport}>{sport}</option>)}
                                </select>
                                <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-2xl"><SportIcon sport={selectedSport} /></div>
                            </div>
                            <button onClick={createLeaguesAndTeams} className="btn-primary flex items-center"><PlusIcon className="inline-block w-5 h-5 mr-2" />Crear Torneo</button>
                        </div>
                    </div>
                    <div className="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg space-y-4 border-t-4 border-[#101097]">
                        <h3 className="text-2xl font-bold text-gray-900 dark:text-white">Gesti√≥n del Torneo Actual</h3>
                        {visibleLeagues.length === 0 ? <p className="text-center text-gray-500 dark:text-gray-400 py-4">No hay ligas en este torneo.</p> : visibleLeagues.map(league => <LeagueCard key={league.id} league={league} teams={visibleTeams.filter(t => t.leagueId === league.id)} players={visiblePlayers} appId={appId} db={window.firebaseApp.db} showMessage={showMessage} onMatchDayChange={handleMatchDayChange} onEditTeam={handleEditTeam} onAddPlayers={handleOpenAddPlayersModal} onAddNewTeam={onAddNewTeam} />)}
                    </div>
                    <div className="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg space-y-4 border-t-4 border-[#101097]">
                        <h3 className="text-2xl font-bold text-gray-900 dark:text-white">Generar Calendario</h3>
                        {visibleMatches.length > 0 ? (
                            <div className="space-y-4">
                                <div>
                                    <p className="text-gray-600 dark:text-gray-300">Ya existe un calendario. Puedes extenderlo hasta una nueva fecha o borrarlo para empezar de nuevo.</p>
                                </div>
                                <div className="flex items-center space-x-4">
                                    <label htmlFor="end-date-input" className="text-sm font-medium text-gray-700 dark:text-gray-300">Extender hasta:</label>
                                    <input type="date" id="end-date-input" value={scheduleEndDate} onChange={(e) => setScheduleEndDate(e.target.value)} className="p-2 rounded-lg border dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white" />
                                    <button onClick={() => generateSchedule(visibleLeagues, visibleTeams, false)} className="btn-primary flex items-center">Extender</button>
                                </div>
                                <div className="border-t dark:border-gray-700 pt-4">
                                    <button onClick={() => handleDeleteSchedule(visibleLeagueIds)} className="btn-danger flex items-center"><TrashIcon className="inline-block w-5 h-5 mr-2" />Borrar Calendario Actual</button>
                                </div>
                            </div>
                        ) : (
                            <div>
                                <p className="text-gray-600 dark:text-gray-300">Selecciona una fecha de inicio y genera el calendario para el torneo actual.</p>
                                <div className="flex items-center space-x-4 mt-4">
                                    <label htmlFor="start-date-input" className="text-sm font-medium text-gray-700 dark:text-gray-300">Fecha de Inicio:</label>
                                    <input type="date" id="start-date-input" value={scheduleStartDate} onChange={(e) => setScheduleStartDate(e.target.value)} className="p-2 rounded-lg border dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white" />
                                    <button onClick={() => generateSchedule(visibleLeagues, visibleTeams, true)} className="btn-primary flex items-center"><CalendarIcon className="inline-block w-5 h-5 mr-2" />Generar Calendario</button>
                                </div>
                            </div>
                        )}
                    </div>
                    <div className="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg space-y-4 border-t-4 border-[#101097]">
                        <h3 className="text-2xl font-bold text-gray-900 dark:text-white">Informes del Torneo</h3>
                        <div className="space-y-4">
                            <div>
                                <p className="text-gray-600 dark:text-gray-300 mb-2">Generar un reporte de pr√≥ximos partidos para una fecha espec√≠fica.</p>
                                <div className="flex items-center space-x-4">
                                    <label className="text-sm font-medium text-gray-700 dark:text-gray-300">Fecha:</label>
                                    <input type="date" value={upcomingMatchesDate} onChange={(e) => setUpcomingMatchesDate(e.target.value)} className="p-2 rounded-lg border dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white" />
                                    <button onClick={() => generateUpcomingMatchesPdf(visibleMatches)} className="btn-primary">PDF Pr√≥ximos Partidos</button>
                                </div>
                            </div>
                            <div className="border-t dark:border-gray-700 pt-4">
                                 <p className="text-gray-600 dark:text-gray-300 mb-2">Generar un reporte completo de clasificaci√≥n y goleo.</p>
                                <button onClick={() => generateStandingsAndTopScorersPdf(visibleLeagues, visibleTeams, visibleMatches, visiblePlayers)} className="btn-primary">PDF Clasificaci√≥n y Goleo</button>
                            </div>
                            <div className="border-t dark:border-gray-700 pt-4">
                                 <p className="text-gray-600 dark:text-gray-300 mb-2">Generar una lista de equipos y jugadores.</p>
                                <button onClick={() => generateTeamListPdf(visibleLeagues, visibleTeams, visiblePlayers)} className="btn-primary">PDF Lista de Equipos</button>
                            </div>
                        </div>
                    </div>
                    <div className="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg space-y-4 border-t-4 border-[#101097]">
                        <h3 className="text-2xl font-bold text-gray-900 dark:text-white">C√©dula de Partidos</h3>
                        <p className="text-gray-600 dark:text-gray-300">Generar una c√©dula para una fecha espec√≠fica del torneo actual.</p>
                        <div className="flex items-center space-x-4">
                            <label className="text-sm font-medium text-gray-700 dark:text-gray-300">Fecha del Partido:</label>
                            <input type="date" value={refereeMatchDate} onChange={(e) => setRefereeMatchDate(e.target.value)} className="p-2 rounded-lg border dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white" />
                            <button onClick={() => generateRefereeSheetPdf(visibleMatches, visiblePlayers)} className="btn-primary">Generar C√©dula</button>
                        </div>
                    </div>
                    <div className="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg space-y-4 border-t-4 border-[#101097]">
                        <h3 className="text-2xl font-bold text-gray-900 dark:text-white">Registro de Partidos</h3>
                        <div className="flex items-center space-x-4 mb-4">
                            <input type="date" value={selectedDateFilter} onChange={(e) => setSelectedDateFilter(e.target.value)} className="p-2 rounded-lg border dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white" placeholder="Filtrar por fecha" />
                            <select value={selectedLeagueFilter} onChange={(e) => setSelectedLeagueFilter(e.target.value)} className="p-2 rounded-lg border dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white">
                                <option value="">Todas las Ligas</option>
                                {visibleLeagues.sort(sortLeagues).map(league => <option key={league.id} value={league.id}>{league.name}</option>)}
                            </select>
                        </div>
                        <MatchesView matches={visibleMatches} leagues={visibleLeagues} teams={visibleTeams} players={visiblePlayers} getLeagueName={getLeagueName} getTeamName={getTeamName} getPlayersByTeam={getPlayersByTeam} appId={appId} db={window.firebaseApp.db} showMessage={showMessage} selectedDateFilter={selectedDateFilter} selectedLeagueFilter={selectedLeagueFilter} />
                    </div>
                </div>
            );

            const StandingsView = ({ onTeamClick }) => (
                <div className="p-4 space-y-6">
                    <h2 className="text-3xl font-extrabold text-gray-900 dark:text-white mb-4">Clasificaciones y Anotadores</h2>
                    
                    {tournaments.length > 0 ? (
                        <div className="flex items-center space-x-4">
                            <select value={selectedTournamentId} onChange={(e) => setSelectedTournamentId(e.target.value)} className="w-full max-w-md p-3 border border-gray-300 dark:border-gray-600 rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-[#007A4D] bg-white dark:bg-gray-800 text-gray-900 dark:text-white transition-colors">
                                {tournaments.map(t => <option key={t.id} value={t.id}>{t.name}</option>)}
                            </select>
                        </div>
                    ) : (
                        <p className="text-center text-gray-500 dark:text-gray-400 py-8">No hay torneos creados. P√≠dele a un administrador que cree uno.</p>
                    )}

                    {tournaments.length > 0 && visibleLeagues.length === 0 && <p className="text-center text-yellow-600 dark:text-yellow-400 bg-yellow-100 dark:bg-yellow-900/50 p-4 rounded-lg shadow-md">No hay ligas en el torneo seleccionado.</p>}
                    
                    {visibleLeagues.length > 0 && (
                        <div className="mb-4">
                            <select value={selectedStandingsLeagueFilter} onChange={(e) => setSelectedStandingsLeagueFilter(e.target.value)} className="p-2 rounded-lg border dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white shadow-sm">
                                <option value="">Ver Todas las Ligas</option>
                                {visibleLeagues.sort(sortLeagues).map(league => <option key={league.id} value={league.id}>{league.name}</option>)}
                            </select>
                        </div>
                    )}
                    {visibleLeagues.filter(l => selectedStandingsLeagueFilter ? l.id === selectedStandingsLeagueFilter : true).sort(sortLeagues).map(league => (
                        <div key={league.id} className="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-xl space-y-4 border-t-4 border-[#101097]">
                            <h3 className="text-2xl font-bold text-gray-900 dark:text-white flex items-center">
                                <SportIcon sport={league.sport} />
                                {league.name}
                                {league.sport && <span className="text-base font-normal text-gray-500 dark:text-gray-400 ml-2">- {league.sport}</span>}
                            </h3>
                            <div className="flex flex-col lg:flex-row lg:space-x-6 space-y-6 lg:space-y-0">
                                <div className="flex-1 space-y-6">
                                    <div>
                                        <h4 className="text-xl font-bold text-gray-800 dark:text-gray-200 mb-2">Clasificaci√≥n</h4>
                                        <StandingsTable standings={calculateStandings(league.id, visibleTeams, visibleMatches)} onTeamClick={onTeamClick} />
                                    </div>
                                    <div>
                                        <h4 className="text-xl font-bold text-gray-800 dark:text-gray-200 mb-2">√öltimos Resultados</h4>
                                        <ResultsList matches={visibleMatches.filter(m => m.leagueId === league.id)} getTeamName={getTeamName} getTeamLogo={getTeamLogo} onMatchClick={handleMatchClick} />
                                    </div>
                                </div>
                                <div className="lg:w-1/3">
                                    <h4 className="text-xl font-bold text-gray-800 dark:text-gray-200 mb-2">Tabla de Anotadores</h4>
                                    <TopScorersTable scorers={calculateTopScorers(league.id, visibleMatches, visiblePlayers, visibleTeams)} />
                                </div>
                            </div>
                        </div>
                    ))}
                </div>
            );

            const renderView = () => {
                if (isLoading && !isAuthReady) {
                    return (
                        <div className="flex flex-col items-center justify-center min-h-screen bg-gray-100 dark:bg-gray-900">
                            <div className="animate-spin rounded-full h-32 w-32 border-t-4 border-b-4 border-[#101097]"></div>
                            <p className="mt-4 text-[#101097] dark:text-blue-300 text-lg font-semibold">Cargando Datos...</p>
                        </div>
                    );
                }
                switch (view) {
                    case 'standings': return <StandingsView onTeamClick={handleTeamClick} />;
                    case 'admin': return user ? <AdminPanel onAddNewTeam={handleAddNewTeam} /> : (
                        <div className="flex items-center justify-center h-[50vh]">
                            <div className="bg-white dark:bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-sm text-center border-t-4 border-[#101097]">
                                <h3 className="text-2xl font-bold mb-4">Acceso de Administrador</h3>
                                <p className="text-gray-600 dark:text-gray-300 mb-4">Inicia sesi√≥n para administrar los torneos.</p>
                                <input type="email" value={email} onChange={(e) => setEmail(e.target.value)} className="w-full p-3 mb-4 rounded-lg border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-[#101097]" placeholder="Correo electr√≥nico" />
                                <input type="password" value={password} onChange={(e) => setPassword(e.target.value)} onKeyDown={(e) => { if (e.key === 'Enter') handleLogin(); }} className="w-full p-3 mb-4 rounded-lg border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-[#101097]" placeholder="Contrase√±a" />
                                <button onClick={handleLogin} className="btn-primary w-full">Ingresar</button>
                            </div>
                        </div>
                    );
                    default: return <StandingsView onTeamClick={handleTeamClick} />;
                }
            };

            return (
                <div className="min-h-screen bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-white transition-colors duration-300">
                    <nav className="bg-[#facc15] dark:bg-[#f59e0b] p-4 shadow-lg sticky top-0 z-40 border-b-2 border-gray-900/20">
                        <div className="flex justify-between items-center max-w-7xl mx-auto">
                             <div className="flex items-center space-x-4">
                                <span className="text-gray-900 font-bold text-xl">Ligas La Salle Secundaria</span>
                            </div>
                            <div className="flex items-center space-x-1">
                                <button onClick={() => setView('standings')} className={`nav-button ${view === 'standings' ? 'bg-black/10' : ''}`}><TrophyIcon className="inline-block w-5 h-5 mr-2" />Clasificaci√≥n</button>
                                <button onClick={() => setView('admin')} className={`nav-button ${view === 'admin' ? 'bg-black/10' : ''}`}><LockIcon className="inline-block w-5 h-5 mr-2" />Admin</button>
                                {user && (
                                    <button onClick={handleLogout} className="nav-button">Cerrar Sesi√≥n</button>
                                )}
                            </div>
                        </div>
                    </nav>
                    <main className="max-w-7xl mx-auto py-6 px-4">
                        {renderView()}
                    </main>
                    <MatchDetailsModal match={matchDetails} onClose={() => setMatchDetails(null)} getPlayerName={getPlayerName} getTeamName={getTeamName} />
                    <TeamDetailsModal team={selectedTeam} players={players} matches={matches} onClose={() => setSelectedTeam(null)} getTeamName={getTeamName} getTeamLogo={getTeamLogo} />
                    <EditTeamModal team={editingTeam} onClose={handleCloseEditTeam} onSave={handleUpdateTeam} showMessage={showMessage} />
                    <AddPlayersModal team={addingPlayersTeam} onClose={() => setAddingPlayersTeam(null)} onAdd={handleAddMultiplePlayers} showMessage={showMessage} />
                    <Modal show={showModal} message={modalMessage} onClose={() => setShowModal(false)} />
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
    <!-- Cargar los m√≥dulos de Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Exportar los m√≥dulos a la ventana global para que puedan ser usados en el script de tipo "text/babel"
        window.firebaseModules = {
            initializeApp,
            getAuth,
            onAuthStateChanged,
            signInWithEmailAndPassword,
            signOut,
            getFirestore,
            doc,
            getDoc,
            addDoc,
            setDoc,
            updateDoc,
            deleteDoc,
            onSnapshot,
            collection,
            query,
            where,
            getDocs,
        };
    </script>
</body>
</html>